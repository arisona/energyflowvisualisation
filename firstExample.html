<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>first Example</title>
    <script type="text/javascript" src="d3.min.js"></script>
    <script type="text/javascript" src="sankey.js"></script>
    <style>
        @import url(styles/styles.css);

        #chart {
            height: 500px;
        }

        .node rect {
            cursor: move;
            fill-opacity: .9;
            shape-rendering: crispEdges;
        }

        .node text {
            pointer-events: none;
            text-shadow: 0 1px 0 #fff;
        }

        .link {
            fill: none;
            stroke: #000;
            stroke-opacity: .5;
        }

        .link:hover {
            stroke-opacity: .7;
        }

        .linkborder {
            fill: none;
            stroke: #000;
            stroke-opacity: 1;
            stroke-width: 1;
        }

        .wood-coal-waste {
            stroke: rgb(97,65,38);
        }

        .petroleum {
            stroke: rgb(255,165,0);
        }

        .crudeoil {
            stroke: rgb(255, 0, 0);
        }
    </style>
</head>
<body>

<h1>Sankey Diagrams</h1>

<div id="buttons"></div>
<p id="chart">
    <svg>
        <defs>
            <!-- Definitions of patterns with icons for usage in the nodes of the sankey diagram -->
            <pattern id="thermal" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 20 20">
                <image height="20" width="20" xlink:href="thermal.png"></image>
            </pattern>
            <pattern id="import" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 50 100">
                <image height="100" width="50" xlink:href="import.png"></image>
            </pattern>
            <pattern id="households" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 200 130">
                <image height="130" width="200" xlink:href="households.png"></image>
            </pattern>
            <pattern id="industry" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 230 160">
                <image height="160" width="230" xlink:href="industry.png"></image>
            </pattern>
            <pattern id="transport" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 160 160">
                <image height="160" width="160" xlink:href="transport.png"></image>
            </pattern>
            <pattern id="services" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 150 115">
                <image height="115" width="150" xlink:href="transport.png"></image>
            </pattern>
            <pattern id="refineries" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 220 150">
                <image height="150" width="220" xlink:href="refineries.png"></image>
            </pattern>
            <pattern id="changeinstock" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 100 100">
                <image height="100" width="100" xlink:href="changeinstock.png"></image>
            </pattern>
            <pattern id="production" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 70 140">
                <image height="140" width="70" xlink:href="production.png"></image>
            </pattern>
            <pattern id="export" patternUnits="objectBoundingBox" width="1" height="1"
                     preserveAspectRatio="xMidYMid meet" viewBox="0 0 70 170">
                <image height="170" width="70" xlink:href="export.png"></image>
            </pattern>
        </defs>
    </svg>
</p>

<script>

    // Monitor state of mouse buttons. For usage in displays on hovering over a certain element, which i wanted to
    // prevent from happening if a mouse button is pressed.
    var mouseDown = 0;
    document.body.onmousedown = function() {
        ++mouseDown;
    };
    document.body.onmouseup = function() {
        --mouseDown;
    };

    var margin = {top: 1, right: 1, bottom: 6, left: 1};
    var width = 960 - margin.left - margin.right;
    var height = 500 - margin.top - margin.bottom;

    var color = d3.scale.category20();

    var svg = d3.select("#chart").select("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g").attr("id", "sankey")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    var sankey = d3.sankey()
            .nodeWidth(40)
            .nodePadding(10)
            .size([width, height]);

    var path = sankey.link();
    var pathborder = sankey.linkborder();
    var pathtext = function(d) {
        var ys = d.source.y + d.sy + d.dy / 2;
        var yt = d.target.y + d.ty + d.dy / 2;
        return (ys + yt) / 2;
    };

    function formatNumber(number) {
        return d3.format(">,d")(number);
    }

    d3.json("data_custom.json", function (error, graph) {
        if (error) console.warn("Error occurred while parsing JSON file" + error);
        var years = [];
        for (var i = 0; i < graph.data.length; i++) {
            years[i] = graph.data[i].year;
        }
        years.forEach(function (year) {
            // Create a button for each year found in the JSON data.
            // The buttons click action searches for the data corresponding to the year and creates the Sankey
            // diagram from that years data.
            d3.select("#buttons").append("button")
                    .attr("width", 200)
                    .attr("height", 50)
                    .attr("name", year)
                    .on("click", function () {
                        for (var i = 0; i < graph.data.length; i++) {
                            if (graph.data[i].year == year) {
                                createSankey(graph.data[i]);
                                break;
                            }
                        }
                    }).html(year);
        });
    });


    function createSankey(graph) {

        // Clear the svg elements
        svg.selectAll(".node").remove();
        svg.selectAll(".link").remove();
        sankey
                .nodes(graph["nodes"])
                .links(graph["links"])
                .layout(32);

        // Each path is set in a group element for easier manipulation possibilities, like hovering.
        // Each path gets an CSS id with consists of the word link followed by the ids of the source and the target.
        var pathGroups = svg.append("g").selectAll(".link")
                .data(graph.links)
                .enter().append("g").attr("class", "group");


        pathGroups
                .append("path")
                .attr("class", function(d) {
                    var cls = "link ";
                    if (d.source.id == 0 || d.target.id == 0) return cls + "wood-coal-waste";
                    if (d.source.id == 8 || d.target.id == 8) return cls + "petroleum";
                    if (d.source.id == 5 || d.target.id == 5) return cls + "crudeoil";
                    return cls;
                })
                .attr("d", path)
                .style("stroke-width", function (d) {return Math.max(1, d.dy);});

        pathGroups
                .append("text")
                .attr("class", "flowvalue")
                .attr("text-anchor", "middle")
                .attr("transform", null)
                .attr("dy", ".35em");

        pathGroups
                .append("text")
                .attr("class", "flowname")

        // the text element for showing the value of the flow at the middle of each link.

        // On hovering over the link: Show the value of the flow and draw a border around the link.
        // If flows have a strong bend the border does not fit the flow anymore :(
        // Maybe use d3.svg.area()
        pathGroups.on("mouseover", function (d) {
            if (!mouseDown) {
                d3.select(this).select(".flowvalue")
                        .attr("x", function (d) {
                            return (d.source.x + d.target.x) / 2;
                        })
                        .attr("y", pathtext)
                        .text(formatNumber(d.value));
                d3.select(this).select(".flowname")
                        .attr("x", d.source.x + 6 + sankey.nodeWidth())
                        .attr("text-anchor", "start")
                        .attr("y", function (d) {
                            return d.source.y;
                        })
                        .attr("dy", ".35em")
                        .attr("transform", null)
                        .text(function (d) {
                            return d.source.name;
                        })
            }
//            disabled border drawing on hover
//            d3.select(this).append("path")
//                    .attr("class", "linkborder")
//                    .attr("d", pathborder);
        });

        // On leaving the link: Remove value text and the border.
        pathGroups.on("mouseleave", function (d) {
            d3.select(this).selectAll("text").text(null);
//            d3.select(this).selectAll(".linkborder").remove();
        });

        // Dragging behavior of nodes disabled.
        var node = svg.append("g").selectAll(".node")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", function (d) {return "translate(" + d.x + "," + d.y + ")";})
                .call(d3.behavior.drag()
                        .origin(function (d) { return d; })
                        .on("dragstart", function () {this.parentNode.appendChild(this);})
                        .on("drag", dragmove));

        node.append("rect")
                .attr("height", function (d) {return d.dy;})
                .attr("width", sankey.nodeWidth())
//                .style("fill", "url(#thermal)")
                .style("fill", function(d){
                    var regex  = new RegExp("Import");
                    if (regex.test(d.name)) return "url(#import)";

                    regex  = new RegExp("Export");
                    if (regex.test(d.name)) return "url(#export)";

                    regex  = new RegExp("Thermal");
                    if (regex.test(d.name)) return "url(#thermal)";

                    regex  = new RegExp("Refineries");
                    if (regex.test(d.name)) return "url(#refineries)";

                    regex  = new RegExp("Change in Stock");
                    if (regex.test(d.name)) return "url(#changeinstock)";

                    regex  = new RegExp("Production");
                    if (regex.test(d.name)) return "url(#production)";

                    regex = new RegExp("Households");
                    if (regex.test(d.name)) return "url(#households)";

                    regex = new RegExp("Industry");
                    if (regex.test(d.name)) return "url(#industry)";

                    regex = new RegExp("Transport");
                    if (regex.test(d.name)) return "url(#transport)";

                    regex = new RegExp("Services");
                    if (regex.test(d.name)) return "url(#services)";

                    regex = new RegExp("Crude Oil");
                    if (regex.test(d.name)) return "rgb(255, 0, 0)";

                    regex = new RegExp("Petroleum");
                    if (regex.test(d.name)) return "rgb(255,165,0)";

                    regex = new RegExp("Wood");
                    if (regex.test(d.name)) return "rgb(97,65,38)";

                    return "#ffffff";
                })
                .style("stroke", function (d) {return d3.rgb(d.color).darker(2);})
                .append("title")
                .text(function (d) {return d.name + "\n" + formatNumber(d.value);});

        function dragmove(d) {
            d3.select(this).attr("transform", "translate(" + d.x + "," +
                    (d.y = Math.max(0, Math.min(height - d.dy, d3.event.y))) + ")");
            sankey.relayout();
            pathGroups.select(".link").attr("d", path);
        }
    }
</script>
</body>
</html>

