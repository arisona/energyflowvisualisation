<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>first Example</title>
    <script type="text/javascript" src="d3.min.js"></script>
    <script type="text/javascript" src="sankey.js"></script>
    <script type="text/javascript" src="d3.slider.js"></script>
    <script type="text/javascript" src="dataQueries.js"></script>
    <style>
        @import url(styles/styles.css);
        @import url(styles/d3.slider.css);


        body {
            font-family: Verdana,Arial,sans-serif;
        }

        #slider {
            margin-left: 20px;
            margin-right: 20px;
        }

        rect.node {
            stroke-width: 1px;
            stroke: black;
        }

        path.linkPath {
            fill: none;
            stroke: #000;
            stroke-opacity: .5;
        }

        path.linkPath:hover {
            stroke-opacity: .7;
        }

        /*path.linkborder {*/
            /*fill: none;*/
            /*stroke: #000;*/
            /*stroke-opacity: 1;*/
            /*stroke-width: 1;*/
        /*}*/

        rect.energytype {
            stroke-width: 0;
            fill-opacity: .5;
        }

    </style>
</head>
<body>

<svg id="chart"></svg>

<div id="slider"></div>

<script>

    // Monitor state of mouse buttons. For usage in displays on hovering over a certain element, which i wanted to
    // prevent from happening if a mouse button is pressed.
    var mouseDown = 0;
    document.body.onmousedown = function() { ++mouseDown; };
    document.body.onmouseup = function() { --mouseDown; };

    /* unused */
//    var mouseover = 0;
//    document.body.onmouseover = function() { ++mouseover; };
//    document.body.onmouseover = function() { --mouseover; };

    // example when changing the sankey data:
//    var imports = theData.nodes[1]
//    d3.selectAll(".node")
//            .data(theData.nodes).transition()
//            .attr("class", "node")
//            .attr("transform", function (d) {return "translate(" + d.x + "," + d.y + ")";})

    // A good aspect ratio for the diagrams is 1.9.
    // Calculated from the canvas width and height of Mike Bostock's Sankey Diagram example.
    var aspectRatio = 1.9;
    var canvasPadding = 10;
    var canvasMargin = 30; // margin on the right and bottom
    var canvasWidth = window.innerWidth - canvasMargin;
    var canvasHeight = (canvasWidth / aspectRatio )- canvasMargin;
    if (canvasHeight > window.innerHeight) {
        canvasHeight = window.innerHeight - canvasMargin;
        canvasWidth = canvasHeight * aspectRatio;

    }

    var color = d3.scale.category20();

    var svg = d3.select("#chart")
            .attr("width", canvasWidth)
            .attr("height", canvasHeight)
            .style("margin-right", canvasMargin + "px")
            .style("margin-bottom", canvasMargin + "px")
            .style("border", "solid 1px balck")
            .append("g").attr("id", "sankey")
            .attr("transform", "translate(" + canvasPadding + "," + canvasPadding + ")");

    var sankey = d3.sankey()
            .nodeWidth(40)
            .nodePadding(30)
            .size([canvasWidth - 2*canvasPadding, canvasHeight - 2*canvasPadding]);

    var pathtext = function(d) {
        var ys = d.source.y + d.sy + d.dy / 2;
        var yt = d.target.y + d.ty + d.dy / 2;
        return (ys + yt) / 2;
    };

    function formatNumber(number) {
        return d3.format(">,d")(number);
    }


    var startYear = 0;
    getYearsAvailable(createTimeSlider);
    getMaxTotalValue(printMaxTotalValue);
    var intvl = setInterval(function() {
        if (startYear) {
            clearInterval(intvl);
            loadEnergyData(startYear, createDiagram);
        }
    }, 100);

    function createTimeSlider(years) {
        startYear = years[0];
        d3.select('#slider').call(
        d3.slider()
                .axis(d3.svg.axis().orient("top").tickFormat(d3.format()).tickPadding(10))
                .min(startYear)
                .max(years[years.length-1])
                .step(1)
                .on("slide", function(event, value) {
                    loadEnergyData(value, updateDiagram);
                })
        );
    }

    function printMaxTotalValue(maxTotalValue) {
        console.log(maxTotalValue);
    }

    function updateDiagram(graph) {
        sankey.links(graph["links"]);
        sankey.nodes(graph["nodes"]);
        sankey.layout(300);

        /* update links */
        var links = svg.select(".links")
                .selectAll(".link")
                .data(sankey.links());

        /* transition updated links */
        links.select(".linkPath").transition()
                .attr("d", sankey.calcPath)
                .style("stroke-width", function (d) {return Math.max(1, d.dy);});

        /* remove links that are not present in the new data */
        links.exit().remove();

        /* create links that are in the new and not in the old data*/
        createNewLinks(links.enter());

        /* update nodes */
        var nodeJoin = svg.select(".nodes")
                .selectAll(".node")
                .data(sankey.nodes().values(), function(d) { return d.name; });

        /* transition updated links */
        nodeJoin.transition()
                .attr("transform", function (d) {return "translate(" + d.x + "," + d.y + ")";})
                .select("rect")
                .attr("height", function(d) {return d.dy;});
    }

    function createNewLinks(links) {
        links
                .append("g")
                .attr("class", "link")
                .on("mouseover", function (d) {
                    if (!mouseDown) {
                        d3.select(this).append("text")
                                .attr("text-anchor", "middle")
                                .attr("dy", ".35em")
                                .attr("x", function (d) {
                                    return (d.source.x + d.target.x) / 2;
                                })
                                .attr("y", pathtext)
                                .text(formatNumber(d.value));
                    }
                })
                .on("mouseleave", function (d) {
                    d3.select(this).selectAll("text").remove();
                })
                .append("path")
                .attr("class", "linkPath")
                .style("stroke", function(d) {
                    if (d.target.color) return d.target.color;
                    else return d.source.color;
                })
                .attr("d", sankey.calcPath)
                .style("stroke-width", function (d) {return Math.max(1, d.dy);});

//                d3.select(this).append("text")
//                        .attr("x", d.source.x + 6 + sankey.nodeWidth())
//                        .attr("text-anchor", "start")
//                        .attr("y", function (d) {
//                            return d.source.y;
//                        })
//                        .attr("dy", ".35em")
//                        .attr("transform", null)
//                        .text(function (d) {
//                            return d.source.name;
//                        })

    }

    function createNewNodes(nodes) {
        nodes.append("g")
                .attr("class", "node")
                .attr("transform", function (d) {return "translate(" + d.x + "," + d.y + ")";})
                .call(d3.behavior.drag()
                        .origin(function (d) { return d; })
                        .on("dragstart", function () {this.parentNode.appendChild(this);})
                        .on("drag", dragmove))
                .append("rect")
                .attr("height", function(d) {return d.dy;})
                .attr("width", sankey.nodeWidth())
                .attr("class", function(d) {
                    if (d.color) return "energytype";
                    else return "node";
                })
                .attr("fill", function(d) {
                    if (d.color) return d.color;
                    else return "url(#" + d.name + ")";
                })
                .append("title")
                .text(function (d) {return d.name + "\n" + formatNumber(d.value);});

        function dragmove(d) {
            d3.select(this).attr("transform", "translate(" + d.x + "," +
            (d.y = Math.max(0, Math.min(canvasHeight - d.dy, d3.event.y))) + ")");
            sankey.relayout();
            d3.selectAll(".linkPath")
                    .attr("d", sankey.calcPath);
        }

//        nodes.select("rect").append("text").attr("class", "nodename");
//        nodes.select("rect")
//                .on("mouseover", function (d) {
//                    if (!mouseDown) {
//                        d3.select(this).select(".nodename")
//                                .attr("x", d.x + 6 + sankey.nodeWidth())
//                                .attr("y", d.y)
//                                .attr("text-anchor", "start")
//                                .attr("dy", ".35em")
//                                .attr("transform", null)
//                                .text(function(d) {return d.name;});
//                    }
//                });
    }

    function createDiagram(graph) {
        sankey.nodes(graph["nodes"]);
        sankey.links(graph["links"]);
        sankey.layout(300);

        createSVGPatterns();

        /* create links */
        var links = svg.append("g").attr("class", "links")
                .selectAll(".link")
                .data(sankey.links());

        createNewLinks(links.enter());

        /* create nodes */
        var nodes = svg.append("g").attr("class", "nodes")
                .selectAll(".node")
                .data(sankey.nodes().values());

        createNewNodes(nodes.enter());

    }

    function createSVGPatterns() {
        // create patterns in the chart's defs element.
        d3.select("#chart").append("defs").selectAll(".pattern")
                .data(sankey.nodes().values())
                .enter()
                .append("pattern")
                .attr("id", function(d) { return d.name; })
                .attr("class", "pattern")
                .attr("patternUnits", 'objectBoundingBox')
                .attr("width", 1)
                .attr("height", 1)
                .attr("preserveAspectRatio", "xMidYMid meet")
                .attr("viewBox", "0 0 1 1")
                .append("image")
                .attr("xlink:href", function(d) { return d.imgUrl; })
                .attr("width", 1)
                .attr("height", 1);
    }

</script>
</body>
</html>

